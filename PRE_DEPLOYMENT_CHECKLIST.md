# Pre-Deployment Checklist for Poossh Stamp

## ðŸ“‹ Step-by-Step Deployment Guide

### âœ… Step 1: Run Database Migrations in Supabase

Go to your Supabase Dashboard â†’ SQL Editor and run these migrations:

```sql
-- 1. Add subscription columns (if not already added)
ALTER TABLE merchant_portal_users
ADD COLUMN IF NOT EXISTS subscription_status VARCHAR(50) DEFAULT 'inactive',
ADD COLUMN IF NOT EXISTS subscription_plan VARCHAR(50),
ADD COLUMN IF NOT EXISTS stripe_customer_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS stripe_subscription_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS subscription_start_date TIMESTAMP,
ADD COLUMN IF NOT EXISTS subscription_end_date TIMESTAMP;

-- 2. Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_subscription_status ON merchant_portal_users(subscription_status);
CREATE INDEX IF NOT EXISTS idx_stripe_customer_id ON merchant_portal_users(stripe_customer_id);
CREATE INDEX IF NOT EXISTS idx_merchants_created_by ON merchants(created_by);
CREATE INDEX IF NOT EXISTS idx_merchants_is_active ON merchants(is_active);

-- 3. Verify tables exist
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

**Expected tables:**
- `merchant_portal_users`
- `merchant_portal_sessions`
- `merchants`
- `merchant_onboarding_data` (optional)
- `merchant_dashboard_preferences` (optional)
- `stamp_cards`
- `rewards`

---

### âœ… Step 2: Get Stripe LIVE Keys

âš ï¸ **Important:** You need to switch from TEST mode to LIVE mode in Stripe!

1. Go to [Stripe Dashboard](https://dashboard.stripe.com)
2. **Toggle to LIVE mode** (switch in sidebar)
3. Go to **Developers** â†’ **API keys**
4. Copy:
   - Publishable key: `pk_live_...`
   - Secret key: `sk_live_...`

5. Go to **Products** and get LIVE price IDs:
   - Starter plan price ID: `price_...`
   - Pro plan price ID: `price_...`

**Note:** You'll need to recreate your products in LIVE mode if they don't exist yet!

---

### âœ… Step 3: Push to GitHub

```bash
cd /Users/lailaparedes/OfficialStamp/webpage

# Check current changes
git status

# Add all changes
git add .

# Commit
git commit -m "Prepare for production deployment"

# Push to main branch
git push origin main
```

---

### âœ… Step 4: Deploy to Render

#### Option A: Deploy via Render Dashboard (Recommended)

1. Go to [https://dashboard.render.com](https://dashboard.render.com)
2. Click **"New +"** â†’ **"Web Service"**
3. Select your GitHub repo: `lailaparedes/poossh_stamp`
4. Render will detect `render.yaml` automatically

5. **Configure Environment Variables:**
   ```
   NODE_ENV=production
   PORT=3000
   SUPABASE_URL=https://ntxpoezharyyftyuywgu.supabase.co
   SUPABASE_ANON_KEY=[your-anon-key]
   JWT_SECRET=[auto-generated by Render]
   
   STRIPE_SECRET_KEY=sk_live_... (LIVE KEY!)
   STRIPE_PUBLISHABLE_KEY=pk_live_... (LIVE KEY!)
   STRIPE_WEBHOOK_SECRET=[Leave empty for now]
   STRIPE_STARTER_PRICE_ID=price_...
   STRIPE_PRO_PRICE_ID=price_...
   
   APP_URL=https://your-app.onrender.com (or custom domain)
   ```

6. Click **"Create Web Service"**
7. Wait for deployment (5-10 minutes)

---

### âœ… Step 5: Set Up Stripe Webhook

After deployment is complete:

1. Get your production URL from Render (e.g., `https://poossh-stamp.onrender.com`)

2. Go to **Stripe Dashboard** â†’ **Developers** â†’ **Webhooks**

3. Click **"Add endpoint"**

4. **Endpoint URL:** `https://your-production-url.com/api/stripe/webhook`

5. **Select events to listen for:**
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_failed`

6. **Copy the signing secret** (starts with `whsec_`)

7. **Add to Render:**
   - Go to your Render service â†’ **Environment**
   - Add variable: `STRIPE_WEBHOOK_SECRET=whsec_...`
   - Save

8. **Redeploy** the service for changes to take effect

---

### âœ… Step 6: Set Up Custom Domain (poossh.com)

1. **In Render:**
   - Go to your service â†’ **Settings**
   - Scroll to **"Custom Domain"**
   - Click **"Add Custom Domain"**
   - Enter: `poossh.com` (or `app.poossh.com`)

2. **Update DNS Records:**
   Render will provide instructions. Typically:
   
   **For root domain (poossh.com):**
   ```
   Type: A
   Name: @
   Value: [IP from Render]
   ```
   
   **For subdomain (app.poossh.com):**
   ```
   Type: CNAME
   Name: app
   Value: [hostname from Render]
   ```

3. **SSL Certificate:**
   - Render automatically generates SSL certificate
   - Wait 5-10 minutes for DNS propagation
   - Your site will be live at `https://poossh.com`

---

### âœ… Step 7: Post-Deployment Testing

Test the following on your live site:

- [ ] Homepage loads (https://poossh.com)
- [ ] Signup flow works
- [ ] Login works
- [ ] Plan selection appears after signup
- [ ] Stripe checkout works with LIVE mode
- [ ] After payment, redirects back to success page
- [ ] Can create loyalty card
- [ ] Dashboard displays data
- [ ] Customers page works
- [ ] Profile page shows subscription
- [ ] Can upgrade/downgrade plans
- [ ] Manage billing button opens Stripe portal

---

### âœ… Step 8: Update Stripe Return URLs

Make sure Stripe uses your production domain:

1. Go to Stripe Dashboard â†’ **Settings** â†’ **Branding**
2. Update:
   - Success URL: `https://poossh.com/subscription-success?session_id={CHECKOUT_SESSION_ID}`
   - Cancel URL: `https://poossh.com/select-plan`

---

## ðŸŽ¯ Quick Command Summary

```bash
# 1. Push to GitHub
git add .
git commit -m "Production ready"
git push origin main

# 2. Your deployment will auto-trigger on Render!
```

---

## ðŸ”§ Troubleshooting

### Build fails on Render
- Check Node.js version is >= 18
- Verify all dependencies in package.json
- Check build logs in Render dashboard

### Site not loading
- Check environment variables are set
- Verify Supabase URL and keys are correct
- Check logs for errors

### Stripe not working
- Confirm you're using LIVE keys (not TEST)
- Verify webhook is configured
- Check webhook signing secret is set

### Database errors
- Ensure all migrations have been run
- Check Supabase connection
- Verify table names match code

---

## ðŸ“Š Monitoring

**View Logs:**
- Render Dashboard â†’ Your Service â†’ **"Logs"**
- Real-time log streaming
- Filter and search logs

**Performance:**
- Monitor response times
- Check for errors in logs
- Set up alerts in Render

---

## ðŸ’° Cost Breakdown

| Service | Plan | Cost |
|---------|------|------|
| Render | Starter | $7/month |
| Supabase | Free | $0 |
| **Total** | | **$7/month** |

**For production, recommend:**
- Render Starter: $7/month (no sleep, better performance)
- Stripe fees: 2.9% + 30Â¢ per transaction
- Domain: ~$12/year (if not already owned)

---

## ðŸš€ You're Ready!

Once you complete all steps above, your Poossh Stamp merchant portal will be:
- âœ… Live at https://poossh.com
- âœ… Processing real payments
- âœ… Fully functional
- âœ… Auto-deploying on git push

**Need help?** Check logs in Render dashboard or Supabase for any errors.
